{
  "version": 3,
  "file": "file-processor.js",
  "sourceRoot": "..\\..\\",
  "sources": [
    "src\\lib\\file-processor.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "# file-processor.coffee\r\n\r\nimport {compile as compileCoffee} from 'coffeescript'\r\nimport {compile as compileSvelte} from 'svelte/compiler'\r\n\r\nimport {\r\n\tundef, defined, notdefined, getOptions, OL, LOG,\r\n\tisString, isFunction, isArray, isHash,\r\n\tassert, croak, keys, hasKey, nonEmpty, gen2block,\r\n\t} from '@jdeighan/llutils'\r\nimport {execCmd} from '@jdeighan/llutils/exec-utils'\r\nimport {\r\n\tisProjRoot, isFile, allFiles, barf, slurp,\r\n\tfileExt, withExt, mkpath, relpath,\r\n\tallFilesMatching, readTextFile, newerDestFileExists,\r\n\t} from '@jdeighan/llutils/fs'\r\nimport {getConfig} from '@jdeighan/llutils/config'\r\n\r\nhConfig = getConfig()\r\n\r\n# ---------------------------------------------------------------------------\r\n\r\nexport removeOutFile = (filePath) =>\r\n\r\n\text = fileExt(filePath)\r\n\t{outExt} = hConfig[ext]\r\n\tif defined(outExt)\r\n\t\texecCmd \"rm #{withExt(filePath, outExt)}\"\r\n\treturn\r\n\r\n# ---------------------------------------------------------------------------\r\n# --- processes all files with file ext in hConfig\r\n#     unprocessed, but matching files are\r\n#        checked for files they use\r\n\r\nexport procFiles = (pattern=\"./{*.*,**/*.*}\", hOptions={}) =>\r\n\r\n\t{debug, force} = getOptions hOptions, {\r\n\t\tdebug: false\r\n\t\tforce: false\r\n\t\t}\r\n\tif hConfig.force\r\n\t\tforce = true\r\n\r\n\t# --- accumulate over all files\r\n\tlProcessed = []\r\n\thUses = {}        # --- { <file>: [<used file>, ...], ...}\r\n\r\n\t# --- set in filter (filter needs meta data, so save results)\r\n\thMetaData = undef   # --- set for all matching files\r\n\tcontents = undef    #     set only for files that are processed\r\n\r\n\t# --- fileFilter is called for every matching file, changed or not\r\n\t#     we need to check meta data for every matching file\r\n\t#     so, we update lProcessed and hUses here\r\n\r\n\tfileFilter = ({filePath}) =>\r\n\r\n\t\text = fileExt filePath\r\n\r\n\t\t# --- If we're not processing file, simply return false\r\n\t\tif !hasKey(hConfig, ext)\r\n\t\t\treturn false\r\n\t\tif force\r\n\t\t\treturn true\r\n\t\toutExt = hConfig[ext].outExt\r\n\t\tdestFile = withExt(filePath, outExt)\r\n\t\treturn ! newerDestFileExists(filePath, destFile)\r\n\r\n\tfor {relPath} from allFilesMatching(pattern, {fileFilter})\r\n\t\t{processed, lUses} = await procOneFile relPath, hOptions\r\n\t\tlProcessed.push relPath\r\n\t\tif nonEmpty(lUses)\r\n\t\t\thUses[relPath] = lUses\r\n\r\n\treturn {\r\n\t\tlProcessed\r\n\t\thUses\r\n\t\t}\r\n\r\n# ---------------------------------------------------------------------------\r\n# --- strFunc must have the following signature:\r\n#        params: (code, hMetaData, filePath)\r\n#        return value:\r\n#           either a string (e.g. code)\r\n#           or a hash with keys:\r\n#              code\r\n#              sourceMap (optional)\r\n#              lUses - an array, possibly empty\r\n#     strFunc may be ASYNC!!!\r\n# ---------------------------------------------------------------------------\r\n\r\nexport procOneFile = (filePath, hOptions={}) =>\r\n\r\n\tassert isFile(filePath), \"No such file: #{OL(filePath)}\"\r\n\t{strFunc, fileFunc, outExt} = hConfig[fileExt(filePath)]\r\n\tif notdefined(outExt)\r\n\t\treturn {\r\n\t\t\tprocessed: false\r\n\t\t\tlUses: []\r\n\t\t\t}\r\n\r\n\tassert isString(outExt) && outExt.startsWith('.'),\r\n\t\t\t\"Bad config: #{OL(hConfig)}\"\r\n\tassert isFunction(strFunc) || isFunction(fileFunc),\r\n\t\t\"neither strFunc or fileFunc is a function\"\r\n\r\n\t{debug, logOnly, echo} = getOptions hOptions, {\r\n\t\tdebug: false\r\n\t\tlogOnly: false\r\n\t\techo: true\r\n\t\t}\r\n\r\n\trelPath = relpath filePath\r\n\tif echo || logOnly\r\n\t\tLOG relPath\r\n\tif logOnly\r\n\t\treturn {\r\n\t\t\tprocessed: false\r\n\t\t\tlUses: []\r\n\t\t\t}\r\n\r\n\tif isFunction(fileFunc)\r\n\t\thResult = await fileFunc filePath, hOptions\r\n\t\tassert isHash(hResult), \"result not a hash (1): #{OL(hResult)}\"\r\n\telse\r\n\t\t# --- get file contents, including meta data\r\n\t\t{hMetaData, contents} = readTextFile(filePath, 'eager')\r\n\t\tassert isString(contents), \"contents not a string: #{OL(contents)}\"\r\n\t\tassert nonEmpty(contents), \"empty contents: #{OL(contents)}\"\r\n\t\thResult = await strFunc contents, hMetaData, relPath, hOptions\r\n\t\tassert isHash(hResult), \"result not a hash (2): #{OL(hResult)}\"\r\n\t{code, sourceMap, hOtherFiles, lUses} = hResult\r\n\r\n\t# --- Write out main output file\r\n\tassert isString(code), \"code not a string: #{OL(code)}\"\r\n\tassert nonEmpty(code), \"empty code: #{OL(code)}\"\r\n\tbarf code, withExt(relPath, outExt)\r\n\r\n\t# --- Write out final source map\r\n\tif defined(sourceMap)\r\n\t\tbarf sourceMap, withExt(relPath, \"#{outExt}.map\")\r\n\r\n\t# --- Write out other files\r\n\tif defined(hOtherFiles)\r\n\t\tfor ext in keys(hOtherFiles)\r\n\t\t\tbarf hOtherFiles[ext], withExt(relPath, ext)\r\n\r\n\treturn {\r\n\t\tprocessed: true\r\n\t\tlUses: lUses || {}\r\n\t\t}\r\n\r\n# ---------------------------------------------------------------------------\r\n"
  ]
}